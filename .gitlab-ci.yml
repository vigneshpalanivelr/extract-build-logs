stages:
  - formatcheck
  - test
  - coverage

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .cache/pip


.python_base:
  image: artifact.internal.com:9999/python:3.11-slim
  tags:
    - executor:dind-socket
  before_script:
    - python --version
    - pip config set 'global.index-url' https://$ARTIFACTORY_USER:$ARTIFACTORY_PASS@artifact.internal.com/artifactory/api/pypi/pypi.org/simple
    - pip install --trusted-host artifact.internal.com pylint  pytest pytest-cov
    - pip install --upgrade pip --trusted-host artifact.internal.com -r requirements.txt

# ============================================================================
# LINT STAGE - Code Quality Checks
# ============================================================================

flake8:
  stage: formatcheck
  image: git.internal.com:9999/repo/flake8-py37
  script:
    - flake8 --max-line-length 120
  allow_failure: true

pylint:
  extends: .python_base
  stage: formatcheck
  script:
    - echo "Running pylint on entire project"
    - pylint src/ --max-line-length=120
  allow_failure: true

# ============================================================================
# TEST STAGE - Unit Tests
# ============================================================================

pytest:
  extends: .python_base
  stage: test
  script:
    - pytest tests/ --ignore=tests/test_manage_container.py -v --tb=short
  allow_failure: true

# ============================================================================
# COVERAGE STAGE - Code Coverage Analysis
# ============================================================================

coverage:
  extends: .python_base
  stage: coverage
  script:
    - pip install pytest pytest-cov
    - pytest tests/ --ignore=tests/test_manage_container.py
        --cov=src
        --cov-report=term-missing
        --cov-report=html:coverage_html
        --cov-report=xml:coverage.xml
        --junitxml=report.xml
    - coverage report
    - coverage xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  allow_failure: true